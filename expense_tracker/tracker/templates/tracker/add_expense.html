{% extends "tracker/base.html" %}

{% block content %}
<div class="relative min-h-screen flex items-center justify-center bg-gradient-to-r from-green-400 to-blue-500 overflow-hidden">

    <!-- Background shapes -->
    <div class="absolute -top-32 -left-32 w-96 h-96 bg-pink-400 rounded-full opacity-30 animate-pulse-slow"></div>
    <div class="absolute -bottom-40 -right-40 w-96 h-96 bg-yellow-400 rounded-full opacity-30 animate-pulse-slow"></div>

    <!-- Card -->
    <div class="relative z-10 w-full max-w-lg bg-white rounded-3xl shadow-xl p-10 animate-fadeIn">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 animate-bounce text-center">Add New Expense</h2>

        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <p class="text-red-600 font-semibold">{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Expense Form -->
        <form method="POST" enctype="multipart/form-data" class="space-y-5" id="expense-form">
            {% csrf_token %}
            {{ form.as_p }}

            <button type="submit" 
                class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-green-700 hover:scale-105 transition transform duration-300">
                Add Expense
            </button>
        </form>

        <!-- Voice Input -->
        <div class="mt-6 text-center">
            <button id="start-voice" 
                class="bg-blue-600 text-white px-5 py-2 rounded-xl shadow-md hover:bg-blue-700 transition">
                ğŸ¤ Speak Expense
            </button>
            <p id="voice-output" class="mt-3 text-gray-700"></p>
        </div>
    </div>
</div>

<script>
    const startBtn = document.getElementById("start-voice");
    const output = document.getElementById("voice-output");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
        output.innerText = "âŒ SpeechRecognition not supported in this browser.";
    } else {
        const recognition = new SpeechRecognition();
        recognition.lang = "en-IN"; // English (India) for better parsing
        recognition.interimResults = false;

        startBtn.onclick = () => {
            recognition.start();
            output.innerText = "ğŸ™ï¸ Listening...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            output.innerText = "âœ… You said: " + transcript;

            // Example voice: "Add 500 for food" â†’ amount=500, category=Food
            let words = transcript.split(" ");
            let amount = words.find(w => !isNaN(w)); // first number
            let category = "Misc"; // fallback

            if (transcript.toLowerCase().includes("food")) category = "Food";
            else if (transcript.toLowerCase().includes("travel")) category = "Travel";
            else if (transcript.toLowerCase().includes("shopping")) category = "Shopping";

            // Fill Django form fields dynamically
            const amountField = document.querySelector("input[name='amount']");
            const titleField = document.querySelector("input[name='title']");
            const categoryField = document.querySelector("select[name='category']");

            if (amountField) amountField.value = amount || "";
            if (titleField) titleField.value = transcript;
            if (categoryField) {
                for (let option of categoryField.options) {
                    if (option.text.toLowerCase() === category.toLowerCase()) {
                        option.selected = true;
                        break;
                    }
                }
            }

            output.innerText += ` â†’ Auto-filled form (Amount: ${amount || "?"}, Category: ${category})`;
        };

        recognition.onerror = (event) => {
            output.innerText = "âš ï¸ Error: " + event.error;
        };
    }
</script>
{% endblock %}
