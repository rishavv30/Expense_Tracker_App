{% extends "tracker/base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow-lg">
    <h2 class="text-2xl font-bold mb-4 text-center">üí¨ Expense AI Assistant</h2>
    
    <!-- Chat Box -->
    <div id="chat-box" class="h-80 overflow-y-auto border p-3 rounded bg-gray-50 mb-4"></div>

    <!-- Chat Input -->
    <form id="chat-form" class="flex mb-3">
        <input type="text" id="question" placeholder="Ask me anything about your expenses..."
            class="flex-grow p-2 border rounded-l-lg focus:outline-none">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-r-lg">Send</button>
    </form>

    <!-- Reset Button -->
    <button id="reset-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg">üßπ Reset Memory</button>
</div>

<script>
document.getElementById("chat-form").onsubmit = async (e) => {
    e.preventDefault();
    const question = document.getElementById("question").value;
    const chatBox = document.getElementById("chat-box");

    if (!question.trim()) return;

    chatBox.innerHTML += `<p><b>You:</b> ${question}</p>`;

    let response = await fetch("{% url 'ai_chat' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ message: question })
    });

    let data = await response.json();
    if (data.reply) {
        chatBox.innerHTML += `<p><b>Bot:</b> ${data.reply}</p>`;
    } else {
        chatBox.innerHTML += `<p><b>Bot:</b> Sorry, something went wrong.</p>`;
    }

    document.getElementById("question").value = "";
    chatBox.scrollTop = chatBox.scrollHeight;
};

// Reset memory
document.getElementById("reset-btn").onclick = async () => {
    const chatBox = document.getElementById("chat-box");

    let response = await fetch("{% url 'reset_ai_memory' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        }
    });

    let data = await response.json();
    if (data.success) {
        chatBox.innerHTML += `<p><b>Bot:</b> üßπ Memory has been cleared.</p>`;
    } else {
        chatBox.innerHTML += `<p><b>Bot:</b> ‚ö†Ô∏è ${data.msg}</p>`;
    }

    chatBox.scrollTop = chatBox.scrollHeight;
};
</script>
{% endblock %}
